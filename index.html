<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Babylon.js sample code</title>

    <!-- Babylon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.1/howler.min.js"></script>
    <link rel="stylesheet" href="css/main.css">
</head>

<body id="page" onload="fakeLoading()">
    <div class="loader-wrapper" onclick="showPage()">
        <div id="text" class="waviy">
            <span style="--i:1">commands :</span>
            <br>
            <br>
            <span style="--i:1"> </span>
            <span style="--i:1"> </span>
            <span style="--i:1"> </span>
            <span style="--i:1">Left</span>
            <span style="--i:2"></span>
            <span style="--i:3">←</span>
            <span style="--i:4">→</span>
            <span style="--i:5"></span>
            <span style="--i:6">Right</span>
            <br>
            <br>
            <span style="--i:7"> </span>
            <span style="--i:7"> </span>
            <span style="--i:7"> </span>
            <span style="--i:7">Space :</span>
            <span style="--i:8"> Boost </span>
            <span style="--i:9">(God Mode)</span>
            <br>
            <br>
            <span style="--i:10">Click </span>
            <span style="--i:11">to </span>
            <span style="--i:12">continue...</span>
        </div>
        <span id="span" class="loader"><span class="loader-inner"></span></span>
    </div>
    <div id="center">
        <div id="main"></div>
    </div>
    <canvas id="renderCanvas">

    </canvas>
    <script>
        var myVar;
        var highScore;
        function startCD() {
            var boostBar = document.getElementById('center');
            boostBar.style.display = "block"
            carSmoke.start();
            preStartReady = !preStartReady;
            startCar = !startCar;
        }
        function fakeLoading() {
            menuTheme = new Howl({
                src: ['sfx/menu_theme.wav', 'sfx/theme.wav'],
                autoplay: false,
                loop: true,
                volume: 0.3,
            });
            var boostBar = document.getElementById('center');
            boostBar.style.display = "none"
            var div = document.getElementById('text');
            div.style.display = "none"
            myVar = setTimeout(showText, 3000);
        }
        function showText() {
            var span = document.getElementById('span');
            span.style.display = "none"
            var div = document.getElementById('text');
            div.style.display = "block"
        }
        function showPage() {
            $(".loader-wrapper").fadeOut("slow");
            menuTheme.play();
            setTimeout(function () {
            }, 1000);
        }
        function showBoostIcon() {

        }
        function getHighScore() {
            let req = new XMLHttpRequest();
            req.onreadystatechange = () => {
            if (req.readyState == XMLHttpRequest.DONE) {
                var myArr = JSON.parse(req.responseText);
                highScore = myArr.myCar
            }
            };
            req.open("GET", "https://api.jsonbin.io/v3/b/6278d3c538be296761fe87d6/latest", true);
            req.setRequestHeader("X-Master-Key", "$2b$10$fvLNo07/4bn3PusIf/iyXe6xlviXFz4fr9F9Rt5CNgiBG1cYL.MbW");
            req.setRequestHeader("X-Bin-Meta","false");
            req.send();
        }
        const FRAMES_PER_SECOND = 60;
        var carCrash;
        var inputStates = []
        var json = { "name": "CPU particle system", "id": "default system", "capacity": 10000, "emitter": [0, 0, 0], "particleEmitterType": { "type": "ConeParticleEmitter", "radius": 0.1, "angle": 0.7853981633974483, "directionRandomizer": 0, "radiusRange": 1, "heightRange": 1, "emitFromSpawnPointOnly": false }, "textureName": "https://www.babylonjs.com/assets/Flare.png", "invertY": true, "isLocal": false, "animations": [], "beginAnimationOnStart": false, "beginAnimationFrom": 0, "beginAnimationTo": 60, "beginAnimationLoop": false, "startDelay": 0, "renderingGroupId": 0, "isBillboardBased": true, "billboardMode": 7, "minAngularSpeed": 0, "maxAngularSpeed": 0, "minSize": 0.1, "maxSize": 0.2, "minScaleX": 1, "maxScaleX": 1, "minScaleY": 1, "maxScaleY": 1, "minEmitPower": 2, "maxEmitPower": 2, "minLifeTime": 1, "maxLifeTime": 2, "emitRate": 150, "gravity": [0, 0, 0], "noiseStrength": [10, 10, 10], "color1": [1, 1, 1, 1], "color2": [0.7647058823529411, 0.07450980392156863, 0.07450980392156863, 1], "colorDead": [0, 0, 0, 0], "updateSpeed": 0.016666666666666666, "targetStopDuration": 0, "blendMode": 0, "preWarmCycles": 0, "preWarmStepOffset": 1, "minInitialRotation": 0, "maxInitialRotation": 0, "startSpriteCellID": 0, "endSpriteCellID": 0, "spriteCellChangeSpeed": 1, "spriteCellWidth": 0, "spriteCellHeight": 0, "spriteRandomStartCell": false, "isAnimationSheetEnabled": false, "textureMask": [1, 1, 1, 1], "customShader": null, "preventAutoStart": false };
        var world;
        var canvas = document.getElementById("renderCanvas");
        var car;
        var meteors = [];
        var lost = false;
        var khkhkh = 0;
        var khkhkhs = 0;
        var particleSystemCar;
        var theme, menuTheme;
        var scoreGUI;
        var restart = false;
        var onceFunction = true;
        var preStartReady = false;
        var startCar = false;
        var camera;
        var light;
        var turbo;
        var carSmoke;
        var shield;
        carSpeed = 0.02;
        var fps = 2;
        var carCopy;
        var startRenderLoop = function (engine, canvas) {
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    if (restart) {
                        if (onceFunction) {
                            onceFunction = !onceFunction;
                            scene.audioEnabled = !scene.audioEnabled;
                            theme.play();
                            showBoostIcon();
                            setTimeout(async () => {
                                var anim = BABYLON.Animation.CreateAndStartAnimation("anim2", camera, "position", 30, 30, camera.position, new BABYLON.Vector3(0, 12, 0), BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                                await anim.waitAsync();
                                var anim2 = BABYLON.Animation.CreateAndStartAnimation("anim3", camera, "rotation", 30, 30, camera.rotation, new BABYLON.Vector3(Math.PI / 2, Math.PI, 0), BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                                await anim2.waitAsync();
                                camera.position = new BABYLON.Vector3(0, 8, 0)
                                camera.parent = car;
                                setTimeout(startCD, 500);
                            });
                        }
                        if (preStartReady) {

                            SpawnMeteor(scene);
                            SpawnStars()
                            preStartReady = !preStartReady;
                        }
                        if (startCar) {
                            car.move();
                        }

                    
                        updateSpeed();
                    }
                    else {

                    }
                    sceneToRender.render();
                }
            });
        }

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true, disableWebGL2Support: false }); };
        var createScene = function () {
            modifySettings();
            getHighScore();
            var scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);
            scene.enablePhysics(new BABYLON.Vector3(0, -10, 0), new BABYLON.CannonJSPlugin());
            theme = new BABYLON.Sound("theme", "sfx/theme.mp3", scene, null, { loop: true, autoplay: false, volume: 0.3 });
            carCrash = new BABYLON.Sound("carCrash", "sfx/game_over.wav", scene, null, { loop: false, autoplay: false, volume: 0.5 });
            scene.audioEnabled = !scene.audioEnabled;
            // --------light--------
            light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(100, 100, 0), scene);
            light.intensity = 0.8;
            // --------end_light--------

            // --------camera--------
            //var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 8, 0), scene);
            camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(1.25, 4.5, -1), scene);
            camera.setTarget(new BABYLON.Vector3(-1.5, 4.1, 0));
            camera.attachControl(canvas, true);
            // --------end_camera--------

            // --------world----------
            var terrainMaterial = new BABYLON.StandardMaterial("terrainMaterial", scene);
            var diffuse = new BABYLON.Texture("textures/mars_kleur.png", scene);
            var bump = new BABYLON.Texture("textures/mars_bump.png", scene);
            terrainMaterial.bumpTexture = bump;
            terrainMaterial.diffuseTexture = diffuse;
            terrainMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            terrainMaterial.emissiveColor = new BABYLON.Color3(0, 0, 0);
            terrainMaterial.ambientColor = new BABYLON.Color3(0, 0, 0);
            /*var diffuse = new BABYLON.Texture("textures/albedo.png", scene);
            var bump = new BABYLON.Texture("textures/bump.png", scene);
            diffuse.uScale = bump.uScale = 3;
            diffuse.vScale = bump.vScale = 3;
            terrainMaterial.bumpTexture = bump;
            terrainMaterial.diffuseTexture = diffuse;*/
            world = BABYLON.Mesh.CreateSphere("world", 64, 8, scene);
            world.rotation.z = 5;
            world.position = new BABYLON.Vector3(0, 0, 0);
            world.material = terrainMaterial;
            world.physicsImposter = new BABYLON.PhysicsImpostor(world, BABYLON.PhysicsImpostor.SphereImpostor, { mass: 0 }, scene);
            world.renderingGroupId = 3
            createSun();
            // --------end_world--------
            // --------skybox--------
            var skybox = BABYLON.MeshBuilder.CreateBox("SkyBox", { size: 1000.0 }, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.HDRCubeTexture("textures/skybox.hdr", scene, 512);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
            scene.registerBeforeRender(function () {
                skybox.rotation.x += 0.0001;
                skybox.rotation.z += 0.0001;
            });
            // --------end_skybox--------
            // --------car--------
            BABYLON.SceneLoader.ImportMesh("", "scenes/", "car.gltf", scene, function (meshes) {
                for (var i = 0; i < meshes.length; i++) {
                    meshes[i].renderingGroupId = 3;
                }
                shield  = BABYLON.Mesh.CreateSphere("shield", 64, 1.2, scene);
                var matStd = new BABYLON.StandardMaterial("matstd", scene);
                shield.material = matStd;
                matStd.diffuseTexture = new BABYLON.Texture("img/shield.png", scene);
                matStd.diffuseTexture.hasAlpha = true;
                matStd.useAlphaFromDiffuseTexture = true;
                matStd.useSpecularOverAlpha = true;
                matStd.alphaCutOff = 0.4;
                shield.parent = meshes[0];
                shield.renderingGroupId = 3;
                meshes[0].parent = car;
                meshes[0].position.y -= 0.1
                car.visibility = 0;
                shield.isVisible = false;
                scene.registerBeforeRender(function () {
                    shield.rotation.y += 0.03;
                });

            });
            car = BABYLON.MeshBuilder.CreateBox("car", { width: 0.05, height: 0.1, depth: 0.5 }, scene);
            car.position = new BABYLON.Vector3(0, 4.1, 0);
            var transform = new BABYLON.TransformNode("root");
            transform.position = new BABYLON.Vector3(0, 0, 0);
            car.parent = transform;
            car.move = () => {
                transform.rotate(new BABYLON.Vector3(1, 0, 0), -carSpeed * scene.getAnimationRatio(), BABYLON.Space.LOCAL);
                if (inputStates.left) {
                    transform.rotate(new BABYLON.Vector3(0, -1, 0), 0.08 * scene.getAnimationRatio(), BABYLON.Space.LOCAL);
                }
                if (inputStates.right) {
                    transform.rotate(new BABYLON.Vector3(0, 1, 0), 0.08 * scene.getAnimationRatio(), BABYLON.Space.LOCAL);
                }

            };
            
            BABYLON.ParticleHelper.CreateFromSnippetAsync("LCBQ5Y#6", scene, false).then((nitro) => {
                carSmoke = new BABYLON.ParticleSystem("carSmoke", 1000, scene);
                carSmoke.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png", scene);
                carSmoke.minEmitBox = new BABYLON.Vector3(-0.25, -0.25, -0.25);
                carSmoke.maxEmitBox = new BABYLON.Vector3(0.25, 0.25, 0.25);
                carSmoke.color1 = new BABYLON.Color4(0.02, 0.02, 0.02, .02);
                carSmoke.color2 = new BABYLON.Color4(0.02, 0.02, 0.02, .02);
                carSmoke.colorDead = new BABYLON.Color4(0, 0, 0, 0.0);
                carSmoke.minSize = 0.5;
                carSmoke.maxSize = 1.5;
                carSmoke.minLifeTime = 0.3;
                carSmoke.maxLifeTime = 0.75;
                carSmoke.emitRate = 350;
                carSmoke.addSizeGradient(0, 0.15, 0.25);
                carSmoke.addSizeGradient(0.075, 0.25, 0.5);
                carSmoke.addSizeGradient(0.125, 0.3, 0.75);
                carSmoke.addColorGradient(0, new BABYLON.Color4(0.5, 0.5, 0.5, 0), new BABYLON.Color4(0.8, 0.8, 0.8, 0));
                carSmoke.addColorGradient(0.4, new BABYLON.Color4(0.1, 0.1, 0.1, 0.1), new BABYLON.Color4(0.4, 0.4, 0.4, 0.4));
                carSmoke.addColorGradient(0.7, new BABYLON.Color4(0.03, 0.03, 0.03, 0.2), new BABYLON.Color4(0.3, 0.3, 0.3, 0.4));
                carSmoke.addColorGradient(1.0, new BABYLON.Color4(0.0, 0.0, 0.0, 0), new BABYLON.Color4(0.03, 0.03, 0.03, 0));
                carSmoke.addVelocityGradient(0, 0.5, 0.75);
                carSmoke.addVelocityGradient(0.05, 0.4, 0.45);
                carSmoke.addVelocityGradient(0.35, 0.2, 0.25);
                carSmoke.addVelocityGradient(0.5, 0.05, 0.1);
                carSmoke.minInitialRotation = 0;
                carSmoke.maxInitialRotation = Math.PI;
                carSmoke.minAngularSpeed = -1;
                carSmoke.maxAngularSpeed = 1;
                carSmoke.blendMode = BABYLON.ParticleSystem.BLENDMODE_STANDARD;

                var emitter = new BABYLON.TransformNode();
                emitter.parent = carCopy;
                carCopy.isVisible = false;
                turbo = nitro;
                emitter.rotation.x = Math.PI / 2;
                turbo.emitter = emitter;
                particleSystemCar.emitter = emitter;
                turbo.targetStopDuration = 0.2;
                turbo.renderingGroupId = 3;
                carSmoke.emitter = emitter;
                carSmoke.renderingGroupId = 3;
            });
            carCopy = car.clone("carCopy");
            car.renderingGroupId = 3
            particleSystemCar = new BABYLON.ParticleSystem("particles", 8000, scene);
            particleSystemCar.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png", scene);
            particleSystemCar.minLifeTime = 2;
            particleSystemCar.maxLifeTime = 6;
            particleSystemCar.emitRate = 150;
            particleSystemCar.gravity = new BABYLON.Vector3(0.25, 3, 0);
            particleSystemCar.addSizeGradient(0, 0.3, 0.5);
            particleSystemCar.addSizeGradient(0.15, 0.5, 1);
            particleSystemCar.addSizeGradient(0.25, 1, 1.5);
            particleSystemCar.addSizeGradient(0.5, 3, 4);
            particleSystemCar.addColorGradient(0, new BABYLON.Color4(0.5, 0.5, 0.5, 0), new BABYLON.Color4(0.8, 0.8, 0.8, 0));
            particleSystemCar.addColorGradient(0.4, new BABYLON.Color4(0.1, 0.1, 0.1, 0.1), new BABYLON.Color4(0.4, 0.4, 0.4, 0.4));
            particleSystemCar.addColorGradient(0.7, new BABYLON.Color4(0.03, 0.03, 0.03, 0.2), new BABYLON.Color4(0.3, 0.3, 0.3, 0.4));
            particleSystemCar.addColorGradient(1.0, new BABYLON.Color4(0.0, 0.0, 0.0, 0), new BABYLON.Color4(0.03, 0.03, 0.03, 0));
            particleSystemCar.addVelocityGradient(0, 0.5, 0.75);
            particleSystemCar.addVelocityGradient(0.05, 0.4, 0.45);
            particleSystemCar.addVelocityGradient(0.35, 0.2, 0.25);
            particleSystemCar.addVelocityGradient(0.5, 0.05, 0.1);
            particleSystemCar.minInitialRotation = 0;
            particleSystemCar.maxInitialRotation = Math.PI;
            particleSystemCar.minAngularSpeed = -1;
            particleSystemCar.maxAngularSpeed = 1;
            particleSystemCar.blendMode = BABYLON.ParticleSystem.BLENDMODE_STANDARD;
            var sphereEmitter = particleSystemCar.createSphereEmitter(0.05);
            particleSystemCar.minEmitBox = new BABYLON.Vector3(-0.25, -0.25, -0.25);
            particleSystemCar.maxEmitBox = new BABYLON.Vector3(0.25, 0.25, 0.25);
            particleSystemCar.emitter = car;
            particleSystemCar.renderingGroupId = 3;
            //car.showBoundingBox = true;
            // --------end_car--------
            // --------GUI--------
            CreateGUI(scene);
            // --------end_GUI--------
            //
            scene.executeWhenReady(() => {
                var vl = new BABYLON.VolumetricLightScatteringPostProcess('vl', 1, scene.activeCamera, scene.getMeshByName("coreSphere"));
                vl.exposure = 0.5;
                vl.decay = 0.9;
                var v2 = new BABYLON.VolumetricLightScatteringPostProcess('v2', 1, scene.activeCamera, world);
                v2.exposure = 0.275;
                v2.decay = 0.9;
                vl.renderingGroupId = 3;
                v2.renderingGroupId = 3;
            })
            return scene;
        };
        var advancedTexture;
        function CreateGUI(scene) {

            advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI(scene);
            scoreGUI = new BABYLON.GUI.TextBlock();
            scoreGUI.text = myScore;
            scoreGUI.color = "white";
            scoreGUI.fontSize = 24;
            scoreGUI.textHorizontalAlignment = 1;
            scoreGUI.textVerticalAlignment = 0;
            scoreGUI.outlineWidth = 1;

            var startButton = BABYLON.GUI.Button.CreateSimpleButton("but1", "Start Game");
            startButton.width = 0.2;
            startButton.height = 0.1;
            startButton.color = "white";
            startButton.fontSize = 30;
            startButton.background = "grey";
            startButton.cornerRadius = 20;
            startButton.left = -500;
            startButton.top = -100;
            startButton.onPointerUpObservable.add(function () {
                camera.inputs.clear();
                menuTheme.stop();
                startButton._doNotRender = true;
                restart = true;
                image.isVisible = false;
            });

            var image = new BABYLON.GUI.Image("logo", "textures/logo.png");
            image.width = 0.5;
            image.height = 0.3;
            image.top = -250;
            image.left = -400;
            var speedMalus = new BABYLON.GUI.Image("sm", "img/turbo.png");
            speedMalus.width = 0.2;
            speedMalus.height = 0.2;
            speedMalus.top = -270;
            speedMalus.left = -560;
            var slowBonus = new BABYLON.GUI.Image("sb", "img/slow.png");
            slowBonus.width = 0.1;
            slowBonus.height = 0.2;
            slowBonus.top = -270;
            slowBonus.left = -600;
            var swapMalus = new BABYLON.GUI.Image("sM", "img/swapcommand.png");
            swapMalus.width = 0.15;
            swapMalus.height = 0.2;
            swapMalus.top = -270;
            swapMalus.left = -600;
            var shieldBonus = new BABYLON.GUI.Image("sB", "img/octaneshield.png");
            shieldBonus.width = 0.15;
            shieldBonus.height = 0.2;
            shieldBonus.top = -270;
            shieldBonus.left = -600;
            swapMalus.isVisible = false;
            slowBonus.isVisible = false;
            speedMalus.isVisible = false;
            shieldBonus.isVisible = false;
            bmList.push(swapMalus)
            bmList.push(slowBonus)
            bmList.push(speedMalus)
            bmList.push(shieldBonus)
            advancedTexture.addControl(swapMalus);
            advancedTexture.addControl(slowBonus);
            advancedTexture.addControl(speedMalus);
            advancedTexture.addControl(shieldBonus);
            advancedTexture.addControl(image);
            advancedTexture.addControl(scoreGUI);
            advancedTexture.addControl(startButton);

        }
        var bmList = []
        var stopSpin = false;
        var bmId = 0;
        var rd;
        var bonusPicked = false;
        function spinWheel() {
            bonusPicked = true;
            if (bmId == (13 + rd)) {
                stopSpin = true;
                bmId = 0;
                doBonus();
                setTimeout(stopBonus, 5000);
            }
            if (!stopSpin) {
                if (bmId == 0) {
                    bmList[bmId % bmList.length].isVisible = true;
                }
                else {
                    var i = bmId % bmList.length;
                    var j = (i - 1) % bmList.length;
                    if (j == -1)
                        j = bmList.length - 1;
                    bmList[i].isVisible = true;
                    bmList[j].isVisible = false;
                }
                bmId++;
                setTimeout(spinWheel, 100);
            }
        }
        var speedSaved2;
        function doBonus() {
            if (rd == 0) {
                swapEnabled = true;
            }
            else if (rd == 1) {
                speedSaved2 = carSpeed;
                carSpeed = speedSaved2 - 0.01;
            }
            else if (rd == 2) {
                speedSaved2 = carSpeed;
                carSpeed = speedSaved2 + 0.01;
            }
            else if (rd == 3) {
                shield.isVisible = true;
                godMode = true;
            }
        }
        function removeBonus() {
            for (let i = 0; i < bmList.length; i++) {
                const element = bmList[i];
                element.isVisible = false;
            }
        }
        function stopBonus() {
            removeBonus();
            if (rd == 0) {
                swapEnabled = false;
                if (inputStates.left) {
                    inputStates.left = false;
                    inputStates.right = true;
                }
                else if (inputStates.right) {
                    inputStates.left = true;
                    inputStates.right = false;
                }
            }
            else if (rd == 1) {
                carSpeed = speedSaved2
            }
            else if (rd == 2) {
                carSpeed = speedSaved2
            }
            else if (rd == 3) {
                shield.isVisible = false;
                godMode = false;
            }
            stopSpin = false;
            bonusPicked = false;
        }
        var speedSaved;
        var boostReady = true;
        var godMode = false;
        var swapEnabled = false;
        function modifySettings() {

            inputStates.left = false;
            inputStates.right = false;
            inputStates.up = false;
            inputStates.down = false;
            inputStates.space = false;

            window.addEventListener('keydown', (event) => {
                if ((event.key === "ArrowLeft") || (event.key === "q") || (event.key === "Q")) {
                    if (swapEnabled)
                        inputStates.right = true;
                    else
                        inputStates.left = true;
                } else if ((event.key === "ArrowUp") || (event.key === "z") || (event.key === "Z")) {
                    inputStates.up = true;
                } else if ((event.key === "ArrowRight") || (event.key === "d") || (event.key === "D")) {
                    if (swapEnabled)
                        inputStates.left = true;
                    else
                        inputStates.right = true;
                } else if ((event.key === "ArrowDown") || (event.key === "s") || (event.key === "S")) {
                    inputStates.down = true;
                } else if (event.key === " ") {
                    inputStates.space = true;
                }
            }, false);

            window.addEventListener('keyup', (event) => {
                if ((event.key === "ArrowLeft") || (event.key === "q") || (event.key === "Q")) {
                    if (swapEnabled)
                        inputStates.right = false;
                    else
                        inputStates.left = false;
                } else if ((event.key === "ArrowUp") || (event.key === "z") || (event.key === "Z")) {
                    inputStates.up = false;
                } else if ((event.key === "ArrowRight") || (event.key === "d") || (event.key === "D")) {
                    if (swapEnabled)
                        inputStates.left = false;
                    else
                        inputStates.right = false;
                } else if ((event.key === "ArrowDown") || (event.key === "s") || (event.key === "S")) {
                    inputStates.down = false;
                } else if (event.key === " ") {
                    inputStates.space = false;
                }
            }, false);
            window.addEventListener('keypress', (event) => {
                if (event.key = "Space" && boostReady) {
                    greenBar.style.animation = "stretch 5s linear forwards";
                    boostReady = false;
                    godMode = true;
                    speedSaved = carSpeed;
                    carSpeed = 0.07
                    turbo.start();
                    
                    setTimeout(function () {
                        carSpeed = speedSaved;
                        if (!(bonusPicked && rd == 3)) {
                            godMode = false;
                        }
                        
                    }, 200);
                    setTimeout(function () {
                        boostReady = true;
                        greenBar.style.removeProperty('animation');
                    }, 5000);
                }

            }, false);
        }
        var greenBar = document.getElementById('main');
        var blackBar = document.getElementById('center');
        var themeSpeed = 1
        function resetSpeed() {
            themeSpeed = 1
            carSpeed = 0.02;
        }
        function updateSpeed() {
            theme.setPlaybackRate(themeSpeed);
            themeSpeed += 0.00001;
            carSpeed += 0.000005;
        }
        function SpawnMeteor(scene) {
            meteorCrash = new BABYLON.Sound("meteor", "sfx/meteor.wav", scene, null, { loop: false, autoplay: false, volume: 0.2 });
            var meteor = BABYLON.MeshBuilder.CreateSphere("meteor", { diameter: 0.70, segments: 16 }, scene);
            var meteorHitbox = BABYLON.MeshBuilder.CreateSphere("meteorH", { diameter: 0.35, segments: 32 }, scene);
            //meteorHitbox.showBoundingBox = true;
            meteorHitbox.parent = meteor;
            meteorHitbox.renderingGroupId = 3;
            var meteorMaterial = new BABYLON.StandardMaterial("meteorM", scene);
            meteorMaterial.bumpTexture = new BABYLON.Texture("textures/meteor_n.png", scene);
            meteorMaterial.emissiveTexture = new BABYLON.Texture("textures/meteor_e.png", scene);
            meteorMaterial.ambientTexture = new BABYLON.Texture("textures/meteor_ao.png", scene);
            meteorMaterial.diffuseTexture = new BABYLON.Texture("textures/meteor_g.png")
            meteor.material = meteorMaterial;
            meteor.physicsImpostor = new BABYLON.PhysicsImpostor(meteor, BABYLON.PhysicsImpostor.SphereImpostor, { mass: 0 });
            meteor.position = new BABYLON.Vector3(getRandomArbitrary(), getRandomArbitrary(), getRandomArbitrary());
            meteor.actionManager = new BABYLON.ActionManager(scene);
            meteorHitbox.actionManager = new BABYLON.ActionManager(scene);
            meteor.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction(
                    {
                        trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger,
                        parameter: world,
                    },
                    () => {
                        meteorCrash.play();
                    },
                ),
            );
            meteorHitbox.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction(
                    {
                        trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger,
                        parameter: 
                        car,
                        usePreciseIntersection: true,
                    },
                    () => {
                        if (godMode) {
                            meteor.dispose();
                        }
                        else{
                            carSmoke.stop();
                            theme.stop();
                            carCrash.play();     
                            saveHighScore();
                            getHighScore();
                            restart = false;
                            startCar = false;
                            stopSpawning = true;
                            particleSystemCar.start();
                                    var RESTART = setTimeout(function () {
                                        var restartButton = BABYLON.GUI.Button.CreateSimpleButton("but2", "Restart ?");
                                        restartButton.width = 0.2;
                                        restartButton.height = 0.1;
                                        restartButton.color = "white";
                                        restartButton.fontSize = 30;
                                        restartButton.background = "grey";
                                        restartButton.cornerRadius = 20;
                                        restartButton.left = 0;
                                        restartButton.top = 0;

                                        restartButton.onPointerUpObservable.add(function () {
                                            theme.play();
                                            restartButton._doNotRender = true;
                                            myScore = 0;
                                            khkhkh = 0;
                                            car.position = new BABYLON.Vector3(0, 4.1, 0);
                                            for (let index = 0; index < stars.length; index++) {
                                                stars[index].dispose();
                                            }
                                            for (let index = 0; index < meteors.length; index++) {
                                                meteors[index].dispose();
                                            }
                                            meteors = [];
                                            stars = [];
                                            restart = true;
                                            startCar = true;
                                            preStartReady = true;
                                            stopSpawning = false;
                                            carSmoke.start();
                                            particleSystemCar.stop();
                                            resetSpeed();

                                        });
                                        advancedTexture.addControl(restartButton);

                                    }, 3000);
                                }
                    },
            ));
            //meteor.showBoundingBox = true;
            meteors.push(meteor);
            meteor.renderingGroupId = 3;
            var solutions = FindLineSphereIntersections(meteor.position);

            var smokeSystem = new BABYLON.ParticleSystem("particles", 1000, scene);
            smokeSystem.particleTexture = new BABYLON.Texture("textures/flare.png", scene);
            smokeSystem.emitter = meteor;
            smokeSystem.minEmitBox = new BABYLON.Vector3(-0.25, -0.25, -0.25);
            smokeSystem.maxEmitBox = new BABYLON.Vector3(0.25, 0.25, 0.25);
            smokeSystem.color1 = new BABYLON.Color4(0.02, 0.02, 0.02, .02);
            smokeSystem.color2 = new BABYLON.Color4(0.02, 0.02, 0.02, .02);
            smokeSystem.colorDead = new BABYLON.Color4(0, 0, 0, 0.0);
            smokeSystem.minSize = 0.5;
            smokeSystem.maxSize = 1.5;
            smokeSystem.minLifeTime = 0.3;
            smokeSystem.maxLifeTime = 0.75;
            smokeSystem.emitRate = 350;
            smokeSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
            smokeSystem.gravity = new BABYLON.Vector3(0, 0, 0);
            smokeSystem.direction1 = new BABYLON.Vector3(0, 0, 0);
            smokeSystem.direction2 = new BABYLON.Vector3(0, 0, 0);
            smokeSystem.minAngularSpeed = 0;
            smokeSystem.maxAngularSpeed = Math.PI;
            smokeSystem.minEmitPower = 0.25;
            smokeSystem.maxEmitPower = 0.75;
            smokeSystem.updateSpeed = 0.0025;
            // Create a particle system
            var fireSystem = new BABYLON.ParticleSystem("particles", 2000, scene);
            //Texture of each particle
            fireSystem.particleTexture = new BABYLON.Texture("textures/fire.png", scene);
            // Where the particles come from
            fireSystem.emitter = meteor; // the starting object, the emitter
            // Colors of all particles
            fireSystem.minEmitBox = new BABYLON.Vector3(-0.25, -0.25, -0.25);
            fireSystem.maxEmitBox = new BABYLON.Vector3(0.25, 0.25, 0.25);
            fireSystem.color1 = new BABYLON.Color4(1, 0.5, 0, 1.0);
            fireSystem.color2 = new BABYLON.Color4(1, 0.5, 0, 1.0);
            fireSystem.colorDead = new BABYLON.Color4(0, 0, 0, 0.0);
            // Size of each particle (random between...
            fireSystem.minSize = 0.15;
            fireSystem.maxSize = 0.5;
            // Life time of each particle (random between...
            fireSystem.minLifeTime = 0.1;
            fireSystem.maxLifeTime = 0.2;
            // Emission rate
            fireSystem.emitRate = 600;
            // Blend mode : BLENDMODE_ONEONE, or BLENDMODE_STANDARD
            fireSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
            // Set the gravity of all particles
            fireSystem.gravity = new BABYLON.Vector3(0, 0, 0);
            // Direction of each particle after it has been emitted
            fireSystem.direction1 = new BABYLON.Vector3(0, 0, 0);
            fireSystem.direction2 = new BABYLON.Vector3(0, 0, 0);
            // Angular speed, in radians
            fireSystem.minAngularSpeed = 0;
            fireSystem.maxAngularSpeed = Math.PI;
            // Speed
            fireSystem.minEmitPower = 0.5;
            fireSystem.maxEmitPower = 1.5;
            fireSystem.updateSpeed = 0.007;
            fireSystem.targetStopDuration = 2;
            fireSystem.renderingGroupId = 3;
            smokeSystem.targetStopDuration = 2;
            smokeSystem.renderingGroupId = 3;
            fireSystem.start();
            smokeSystem.start();
            startGameTimer();
            BABYLON.Animation.CreateAndStartAnimation("anim", meteor, "position", 30, 60, meteor.position, solutions[0], BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
            if (!stopSpawning)
                setTimeout(SpawnMeteor, 2000);
        }
        var stars = []
        function SpawnStars(scene) {
            var star = CreateStar(4);
            star.position = new BABYLON.Vector3(getRandomArbitrary(), getRandomArbitrary(), getRandomArbitrary());
            var starMaterial = new BABYLON.StandardMaterial("starM", scene);
            starMaterial.diffuseTexture = new BABYLON.Texture("textures/star.png", scene);
            star.material = starMaterial;
            star.actionManager = new BABYLON.ActionManager(scene);
            star.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction(
                    {
                        trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger,
                        parameter: world,
                    },
                    () => {
                        meteorCrash.play();
                    },
                ),
            );
            star.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction(
                    {
                        trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger,
                        parameter: car,
                    },
                    () => {
                        if(!bonusPicked)
                        {
                            rd = randomIntFromInterval(0, 3);
                            spinWheel();
                            star.dispose();
                        }
                    },
                ),
            );
            stars.push(star);
            var particleSystem = new BABYLON.ParticleSystem("particlesR", 2000, scene);
            particleSystem.renderingGroupId = 3;
            particleSystem.particleTexture = new BABYLON.Texture("textures/flare.png", scene);
            particleSystem.emitter = star
            particleSystem.color1 = new BABYLON.Color4(0.7, 0.8, 1.0, 1.0);
            particleSystem.color2 = new BABYLON.Color4(0.2, 0.5, 1.0, 1.0);
            particleSystem.colorDead = new BABYLON.Color4(0, 0, 0.2, 0.0);
            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.5;
            particleSystem.minLifeTime = 0.3;
            particleSystem.maxLifeTime = 0.7;
            particleSystem.emitRate = 1000;
            particleSystem.createSphereEmitter(2);
            particleSystem.minEmitPower = 1;
            particleSystem.maxEmitPower = 3;
            particleSystem.updateSpeed = 0.005;
            particleSystem.targetStopDuration = 1.5;
            particleSystem.updateFunction = function (particles) {
                for (var index = 0; index < particles.length; index++) {
                    var particle = particles[index];
                    particle.age += this._scaledUpdateSpeed;

                    if (particle.age >= particle.lifeTime) { // Recycle
                        particles.splice(index, 1);
                        this._stockParticles.push(particle);
                        index--;
                        continue;
                    }
                    else {
                        particle.colorStep.scaleToRef(this._scaledUpdateSpeed, this._scaledColorStep);
                        particle.color.addInPlace(this._scaledColorStep);
                        particle.color = new BABYLON.Color4(Math.random(), Math.random(), Math.random(), 1)

                        if (particle.color.a < 0)
                            particle.color.a = 0;

                        particle.angle += particle.angularSpeed * this._scaledUpdateSpeed;

                        particle.direction.scaleToRef(this._scaledUpdateSpeed, this._scaledDirection);
                        particle.position.addInPlace(this._scaledDirection);

                        this.gravity.scaleToRef(this._scaledUpdateSpeed, this._scaledGravity);
                        particle.direction.addInPlace(this._scaledGravity);
                    }
                }
            }
            particleSystem.start();
            //star.showBoundingBox = true;
            star.renderingGroupId = 3;
            var solutions = FindLineSphereIntersections(star.position);
            BABYLON.Animation.CreateAndStartAnimation("anim", star, "position", 30, 60, star.position, solutions[0], BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
            if (!stopSpawning)
                setTimeout(SpawnStars, 30000);
        }
        function randomIntFromInterval(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min)
        }
        var stopSpawning = false;
        function FindLineSphereIntersections(meteorPosition) {
            let solutions;
            var circleRadius = 4;
            var cx = 0;
            var cy = 0;
            var cz = 0;

            var px = cx;
            var py = cy;
            var pz = cz;

            var vx = meteorPosition.x;
            var vy = meteorPosition.y;
            var vz = meteorPosition.z;

            var A = vx * vx + vy * vy + vz * vz;
            var B = 2.0 * (px * vx + py * vy + pz * vz - vx * cx - vy * cy - vz * cz);
            var C = px * px - 2 * px * cx + cx * cx + py * py - 2 * py * cy + cy * cy +
                pz * pz - 2 * pz * cz + cz * cz - circleRadius * circleRadius;

            // discriminant
            var D = B * B - 4 * A * C;

            if (D < 0) {
                return new BABYLON.Vector3.Zero();
            }

            var t1 = (-B - Math.sqrt(D)) / (2.0 * A);

            var solution1 = new BABYLON.Vector3(cx * (1 - t1) + t1 * meteorPosition.x,
                cy * (1 - t1) + t1 * meteorPosition.y,
                cz * (1 - t1) + t1 * meteorPosition.z);
            if (D == 0) {
                solutions = [solution1];
                return solutions;
            }

            var t2 = (-B + Math.sqrt(D)) / (2.0 * A);
            var solution2 = new BABYLON.Vector3(cx * (1 - t2) + t2 * meteorPosition.x,
                cy * (1 - t2) + t2 * meteorPosition.y,
                cz * (1 - t2) + t2 * meteorPosition.z);

            // prefer a solution that's on the line segment itself

            if (Math.abs(t1 - 0.5) < Math.abs(t2 - 0.5)) {
                solutions = [solution1, solution2];
                return solutions;
            }

            solutions = [solution2, solution1];
            return solutions;

        }
        function getRandomArbitrary() {
            var sign = Math.random() < 0.5 ? -1 : 1;
            var coord = Math.floor(Math.random() * 50)
            return sign * coord;
        }

        var myScore = 0;
        function startGameTimer() {
            myScore = myScore + 1;
            scoreGUI.text = "Score : " + myScore + "\n Best : " + highScore;
        }

        function saveHighScore() {
            if (highScore <= myScore) {
                let req = new XMLHttpRequest();
                req.onreadystatechange = () => {
                if (req.readyState == XMLHttpRequest.DONE) {
                    console.log(req.responseText);
                }
                };
                req.open("PUT", "https://api.jsonbin.io/v3/b/6278d3c538be296761fe87d6", true);
                req.setRequestHeader("Content-Type", "application/json");
                req.setRequestHeader("X-Master-Key", "$2b$10$fvLNo07/4bn3PusIf/iyXe6xlviXFz4fr9F9Rt5CNgiBG1cYL.MbW");
                req.setRequestHeader("X-Bin-Meta", "false");
                var string = '{"myCar": '+myScore+'}';
                req.send(string);
            }
        };
        function CreateStar(len) {
            var dodecahedron = {
                vertex: [[0, 0, 1.070466], [0.7136442, 0, 0.7978784], [-0.3568221, 0.618034, 0.7978784], [-0.3568221, -0.618034, 0.7978784], [0.7978784, 0.618034, 0.3568221], [0.7978784, -0.618034, 0.3568221], [-0.9341724, 0.381966, 0.3568221], [0.1362939, 1, 0.3568221], [0.1362939, -1, 0.3568221], [-0.9341724, -0.381966, 0.3568221], [0.9341724, 0.381966, -0.3568221], [0.9341724, -0.381966, -0.3568221], [-0.7978784, 0.618034, -0.3568221], [-0.1362939, 1, -0.3568221], [-0.1362939, -1, -0.3568221], [-0.7978784, -0.618034, -0.3568221], [0.3568221, 0.618034, -0.7978784], [0.3568221, -0.618034, -0.7978784], [-0.7136442, 0, -0.7978784], [0, 0, -1.070466]],
                face: [[0, 1, 4, 7, 2], [0, 2, 6, 9, 3], [0, 3, 8, 5, 1], [1, 5, 11, 10, 4], [2, 7, 13, 12, 6], [3, 9, 15, 14, 8], [4, 10, 16, 13, 7], [5, 8, 14, 17, 11], [6, 12, 18, 15, 9], [10, 11, 17, 19, 16], [12, 13, 16, 19, 18], [14, 15, 18, 19, 17]]
            };
            var face = [];
            var pointIndex = 0;
            var centerX = 0;
            var centerY = 0;
            var centerZ = 0;
            var positions = [];
            var indices = [];
            var vec1 = BABYLON.Vector3.Zero();
            var vec2 = BABYLON.Vector3.Zero();
            var norm
            var nbVertices = dodecahedron.vertex.length
            for (var v = 0; v < nbVertices; v++) {
                positions = positions.concat(dodecahedron.vertex[v])
            }
            for (var f = 0; f < 12; f++) {
                face = dodecahedron.face[f];
                centerX = 0;
                centerY = 0;
                centerZ = 0;
                vec1.set(dodecahedron.vertex[face[1]][0] - dodecahedron.vertex[face[0]][0], dodecahedron.vertex[face[1]][1] - dodecahedron.vertex[face[0]][1], dodecahedron.vertex[face[1]][2] - dodecahedron.vertex[face[0]][2]);
                vec2.set(dodecahedron.vertex[face[2]][0] - dodecahedron.vertex[face[1]][0], dodecahedron.vertex[face[2]][1] - dodecahedron.vertex[face[1]][1], dodecahedron.vertex[face[2]][2] - dodecahedron.vertex[face[1]][2]);
                norm = BABYLON.Vector3.Cross(vec1, vec2).normalize();
                for (var v = 0; v < 5; v++) {
                    centerX += dodecahedron.vertex[face[v]][0];
                    centerY += dodecahedron.vertex[face[v]][1];
                    centerZ += dodecahedron.vertex[face[v]][2];
                }
                pointIndex = 1 * (nbVertices + f);
                positions.push(centerX / 6 + len * norm.x, centerY / 6 + len * norm.y, centerZ / 6 + len * norm.z);
                for (var v = 0; v < 5; v++) {
                    indices.push(face[v], pointIndex, face[(v + 1) % 5]);
                }
            }
            var vertexData = new BABYLON.VertexData();

            vertexData.positions = positions;
            vertexData.indices = indices;

            var normals = [];
            BABYLON.VertexData.ComputeNormals(positions, indices, normals);

            vertexData.normals = normals;

            var mesh = new BABYLON.Mesh("star", scene);
            vertexData.applyToMesh(mesh);
            mesh.scaling.x = 0.1
            mesh.scaling.y = 0.1
            mesh.scaling.z = 0.1
            return mesh;
        }

        function createSun() {
            var stars = BABYLON.Mesh.CreateBox("emitter", 0.01, scene);

            // Create a particle system
            var surfaceParticles = new BABYLON.ParticleSystem("surfaceParticles", 1600, scene);
            var flareParticles = new BABYLON.ParticleSystem("flareParticles", 20, scene);
            var coronaParticles = new BABYLON.ParticleSystem("coronaParticles", 600, scene);
            var starsParticles = new BABYLON.ParticleSystem("starsParticles", 500, scene);

            // Texture of each particle
            surfaceParticles.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/ParticleSystems/Sun/T_SunSurface.png", scene);
            flareParticles.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/ParticleSystems/Sun/T_SunFlare.png", scene);
            coronaParticles.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/ParticleSystems/Sun/T_Star.png", scene);
            starsParticles.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/ParticleSystems/Sun/T_Star.png", scene);

            // Create core sphere
            var coreSphere = BABYLON.MeshBuilder.CreateSphere("coreSphere", { diameter: 10, segments: 64 }, scene);
            coreSphere.position = new BABYLON.Vector3(100, 100, 0)
            // Create core material
            var coreMat = new BABYLON.StandardMaterial("coreMat", scene)
            coreMat.emissiveColor = new BABYLON.Color3(0.3773, 0.0930, 0.0266);

            // Assign core material to sphere
            coreSphere.material = coreMat;
            // Pre-warm
            surfaceParticles.preWarmStepOffset = 10;
            surfaceParticles.preWarmCycles = 100;

            flareParticles.preWarmStepOffset = 10;
            flareParticles.preWarmCycles = 100;

            coronaParticles.preWarmStepOffset = 10;
            coronaParticles.preWarmCycles = 100;

            // Initial rotation
            surfaceParticles.minInitialRotation = -2 * Math.PI;
            surfaceParticles.maxInitialRotation = 2 * Math.PI;

            flareParticles.minInitialRotation = -2 * Math.PI;
            flareParticles.maxInitialRotation = 2 * Math.PI;

            coronaParticles.minInitialRotation = -2 * Math.PI;
            coronaParticles.maxInitialRotation = 2 * Math.PI;

            // Where the sun particles come from
            var sunEmitter = new BABYLON.SphereParticleEmitter();
            sunEmitter.radius = 5;
            sunEmitter.radiusRange = 0; // emit only from shape surface

            // Where the stars particles come from
            var starsEmitter = new BABYLON.SphereParticleEmitter();
            starsEmitter.radius = 100;
            starsEmitter.radiusRange = 0; // emit only from shape surface

            // Assign particles to emitters
            surfaceParticles.emitter = coreSphere; // the starting object, the emitter
            surfaceParticles.particleEmitterType = sunEmitter;

            flareParticles.emitter = coreSphere; // the starting object, the emitter
            flareParticles.particleEmitterType = sunEmitter;

            coronaParticles.emitter = coreSphere; // the starting object, the emitter
            coronaParticles.particleEmitterType = sunEmitter;

            starsParticles.emitter = stars; // the starting object, the emitter
            starsParticles.particleEmitterType = starsEmitter;

            // Random starting color
            starsParticles.color1 = new BABYLON.Color4(0.898, 0.737, 0.718, 1.0);
            starsParticles.color2 = new BABYLON.Color4(0.584, 0.831, 0.894, 1.0);

            // Color gradient over time
            surfaceParticles.addColorGradient(0, new BABYLON.Color4(0.8509, 0.4784, 0.1019, 0.0));
            surfaceParticles.addColorGradient(0.4, new BABYLON.Color4(0.6259, 0.3056, 0.0619, 0.5));
            surfaceParticles.addColorGradient(0.5, new BABYLON.Color4(0.6039, 0.2887, 0.0579, 0.5));
            surfaceParticles.addColorGradient(1.0, new BABYLON.Color4(0.3207, 0.0713, 0.0075, 0.0));

            flareParticles.addColorGradient(0, new BABYLON.Color4(1, 0.9612, 0.5141, 0.0));
            flareParticles.addColorGradient(0.25, new BABYLON.Color4(0.9058, 0.7152, 0.3825, 1.0));
            flareParticles.addColorGradient(1.0, new BABYLON.Color4(0.6320, 0.0, 0.0, 0.0));

            coronaParticles.addColorGradient(0, new BABYLON.Color4(0.8509, 0.4784, 0.1019, 0.0));
            coronaParticles.addColorGradient(0.5, new BABYLON.Color4(0.6039, 0.2887, 0.0579, 0.12));
            coronaParticles.addColorGradient(1.0, new BABYLON.Color4(0.3207, 0.0713, 0.0075, 0.0));

            // Size of each particle (random between...
            surfaceParticles.minSize = 0.4 * 5;
            surfaceParticles.maxSize = 0.7 * 5;

            flareParticles.minScaleX = 0.5 * 5;
            flareParticles.minScaleY = 0.5 * 5;
            flareParticles.maxScaleX = 1.0 * 5;
            flareParticles.maxScaleY = 1.0 * 5;

            coronaParticles.minScaleX = 0.5 * 5;
            coronaParticles.minScaleY = 0.75 * 5;
            coronaParticles.maxScaleX = 1.2 * 5;
            coronaParticles.maxScaleY = 3.0 * 5;

            starsParticles.minSize = 0.15 * 5;
            starsParticles.maxSize = 0.3 * 5;

            // Size over lifetime
            flareParticles.addSizeGradient(0 * 5, 0 * 5);
            flareParticles.addSizeGradient(1 * 5, 1 * 5);

            // Life time of each particle (random between...
            surfaceParticles.minLifeTime = 8.0;
            surfaceParticles.maxLifeTime = 8.0;

            flareParticles.minLifeTime = 10.0;
            flareParticles.maxLifeTime = 10.0;

            coronaParticles.minLifeTime = 2.0;
            coronaParticles.maxLifeTime = 2.0;

            starsParticles.minLifeTime = 999999;
            starsParticles.maxLifeTime = 999999;

            // Emission rate
            surfaceParticles.emitRate = 200;
            flareParticles.emitRate = 1;
            coronaParticles.emitRate = 300;

            // Burst rate
            starsParticles.manualEmitCount = 500;
            starsParticles.maxEmitPower = 0.0;

            // Blend mode : BLENDMODE_ONEONE, BLENDMODE_STANDARD, or BLENDMODE_ADD
            surfaceParticles.blendMode = BABYLON.ParticleSystem.BLENDMODE_ADD;
            flareParticles.blendMode = BABYLON.ParticleSystem.BLENDMODE_ADD;
            coronaParticles.blendMode = BABYLON.ParticleSystem.BLENDMODE_ADD;
            starsParticles.blendMode = BABYLON.ParticleSystem.BLENDMODE_STANDARD;

            // Set the gravity of all particles
            surfaceParticles.gravity = new BABYLON.Vector3(0, 0, 0);
            flareParticles.gravity = new BABYLON.Vector3(0, 0, 0);
            coronaParticles.gravity = new BABYLON.Vector3(0, 0, 0);
            starsParticles.gravity = new BABYLON.Vector3(0, 0, 0);

            // Angular speed, in radians
            surfaceParticles.minAngularSpeed = -0.4;
            surfaceParticles.maxAngularSpeed = 0.4;

            flareParticles.minAngularSpeed = 0.0;
            flareParticles.maxAngularSpeed = 0.0;

            coronaParticles.minAngularSpeed = 0.0;
            coronaParticles.maxAngularSpeed = 0.0;

            starsParticles.minAngularSpeed = 0.0;
            starsParticles.maxAngularSpeed = 0.0;

            // Speed
            surfaceParticles.minEmitPower = 0;
            surfaceParticles.maxEmitPower = 0;
            surfaceParticles.updateSpeed = 0.005;

            flareParticles.minEmitPower = 0.001;
            flareParticles.maxEmitPower = 0.01;

            coronaParticles.minEmitPower = 0.0;
            coronaParticles.maxEmitPower = 0.0;

            starsParticles.minEmitPower = 0.0;
            starsParticles.maxAngularSpeed = 0.0;

            // No billboard
            surfaceParticles.isBillboardBased = false;
            flareParticles.isBillboardBased = true;
            coronaParticles.isBillboardBased = true;
            starsParticles.isBillboardBased = true;

            // Render Order
            starsParticles.renderingGroupId = 0;
            coronaParticles.renderingGroupId = 1;
            flareParticles.renderingGroupId = 2;
            surfaceParticles.renderingGroupId = 3;
            coreSphere.renderingGroupId = 3;

            // Start the particle system
            surfaceParticles.start();
            flareParticles.start();
            coronaParticles.start();
            starsParticles.start();

        }
        /////////////////////////////////////////////////////
        window.initFunction = async function () {
            await Ammo();

            var asyncEngineCreation = async function () {
                try {
                    return createDefaultEngine();
                } catch (e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            window.engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            startRenderLoop(engine, canvas);
            window.scene = createScene();
        };
        initFunction().then(() => {
            sceneToRender = scene
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>

</body>

</html>